name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/amr-echafaudage-frontend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          envs: GITHUB_ACTOR,GHCR_PAT,IMAGE_FULL_NAME
          script: |
            echo "ğŸš€ Starting deployment..."
            
            # Navigate to project directory
            cd ~/amr-echaufaudage || { echo "âŒ Project directory not found"; exit 1; }
            echo "âœ… In project directory"
            
            # Pull latest changes from git
            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main || git pull origin master
            
            # Create network if it doesn't exist
            echo "ğŸŒ Ensuring Docker network exists..."
            docker network create amr-network 2>/dev/null && echo "âœ… Network created" || echo "âœ… Network already exists"
            
            # The full image name
            IMAGE_NAME="ghcr.io/${{ github.repository }}/amr-echafaudage-frontend:latest"
            echo "ğŸ“¦ Image: $IMAGE_NAME"
            
            # Try to login to GHCR if PAT is provided (for private images)
            # If the image is public, this step will be skipped or fail gracefully
            if [ -n "${{ secrets.GHCR_PAT }}" ]; then
              echo "ğŸ” Logging in to GHCR with PAT..."
              echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
              if [ $? -eq 0 ]; then
                echo "âœ… Logged in to GHCR"
              else
                echo "âš ï¸  GHCR login failed, assuming image is public"
              fi
            else
              echo "â„¹ï¸  No GHCR_PAT provided, assuming image is public"
            fi
            
            # Pull the latest image
            echo "ğŸ“¥ Pulling latest image..."
            docker pull "$IMAGE_NAME"
            if [ $? -ne 0 ]; then
              echo "âŒ Failed to pull image"
              echo ""
              echo "ğŸ“ Troubleshooting steps:"
              echo "1. Check if image exists: https://github.com/${{ github.repository }}/pkgs/container/amr-echaufaudage%2Famr-echafaudage-frontend"
              echo "2. If image is private, create a PAT and add as GHCR_PAT secret"
              echo "3. Or make the image public in package settings"
              echo ""
              echo "See GHCR-AUTH-GUIDE.md for detailed instructions"
              exit 1
            fi
            echo "âœ… Image pulled successfully"
            
            # Stop and remove old container
            echo "ğŸ›‘ Stopping old container..."
            docker stop amr-frontend 2>/dev/null && echo "âœ… Container stopped" || echo "â„¹ï¸  No container to stop"
            docker rm amr-frontend 2>/dev/null && echo "âœ… Container removed" || echo "â„¹ï¸  No container to remove"
            
            # Start new container
            echo "ğŸš€ Starting new container..."
            docker run -d \
              --name amr-frontend \
              --restart unless-stopped \
              --network amr-network \
              -p 3000:8080 \
              -e NODE_ENV=production \
              --health-cmd="wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1" \
              --health-interval=30s \
              --health-timeout=3s \
              --health-retries=3 \
              --health-start-period=10s \
              "$IMAGE_NAME"
            
            if [ $? -eq 0 ]; then
              echo "âœ… Container started successfully"
            else
              echo "âŒ Failed to start container"
              docker logs amr-frontend 2>&1 || echo "No logs available"
              exit 1
            fi
            
            # Wait a moment for container to start
            sleep 5
            
            # Show running containers
            echo ""
            echo "ğŸ“Š Container Status:"
            docker ps --filter "name=amr-frontend" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            # Clean up old images
            echo ""
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -af --filter "until=24h" || true
            
            echo ""
            echo "âœ… Deployment completed successfully!"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "ğŸ” Verifying deployment..."
            echo ""
            
            # Wait for container to be fully healthy
            echo "â³ Waiting for container to start..."
            sleep 10
            
            # Check if container is running
            if docker ps | grep -q amr-frontend; then
              echo "âœ… Frontend container is running"
              echo ""
              echo "ğŸ“Š Container Status:"
              docker ps --filter "name=amr-frontend" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              echo ""
              echo "ğŸ“ Recent logs:"
              docker logs --tail 20 amr-frontend
              echo ""
              echo "ğŸ” Health check status:"
              docker inspect --format='{{.State.Health.Status}}' amr-frontend 2>/dev/null || echo "Health check starting..."
              echo ""
              echo "ğŸ‰ Deployment verification successful!"
            else
              echo "âŒ Frontend container failed to start"
              echo ""
              echo "ğŸ“ Container logs:"
              docker logs amr-frontend 2>&1 || echo "No logs available"
              echo ""
              echo "ğŸ” All containers:"
              docker ps -a
              exit 1
            fi
